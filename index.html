<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iCare ç®¡å®¶å©† - Trade AI Doc System</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Inter, sans-serif;
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
      }
    </script>
  </head>

  <body class="bg-[#f0f2f5]">
    <div id="root"></div>

    <script type="module">
      import React, { useState, useEffect } from "react";
      import ReactDOM from "react-dom/client";

      /* ===============================
         ğŸ”’ äº‘ç«¯æŒä¹…åŒ–ï¼ˆå”¯ä¸€æ–°å¢ï¼‰
      =============================== */
      import { createPersistence } from "./persistence.js";

      const APP_ID = "icar_bookkeeping";

      /* ===============================
         ğŸ§  åº”ç”¨ä¸»ä½“
      =============================== */
      function App() {
        const [ready, setReady] = useState(false);
        const [state, setState] = useState(null);
        const [persistence, setPersistence] = useState(null);

        // å¯åŠ¨æ—¶åŠ è½½ï¼ˆåŸ localStorage â†’ äº‘ç«¯ï¼‰
        useEffect(() => {
          (async () => {
            const p = await createPersistence();
            const loaded = await p.loadAppState();

            setPersistence(p);
            setState(
              loaded || {
                quotes: [],
                quote_items: [],
                orders: [],
                order_items: [],
                payments: [],
                transactions: [],
                settlements: {}
              }
            );
            setReady(true);
          })();
        }, []);

        // æ¯æ¬¡çŠ¶æ€å˜åŒ– â†’ è‡ªåŠ¨å†™äº‘ç«¯
        useEffect(() => {
          if (!persistence || !state) return;
          persistence.saveAppState(state);
        }, [state, persistence]);

        if (!ready) {
          return (
            <div className="flex items-center justify-center h-screen text-gray-400">
              Loading iCare Systemâ€¦
            </div>
          );
        }

        /* ===============================
           ä¸‹é¢æ˜¯ä½ åŸæœ¬çš„ä¸šåŠ¡é€»è¾‘
           UI / è®¡ç®— / VAT / è®¢å•
           ğŸ‘‰ å…¨éƒ¨å¯ä»¥ç»§ç»­å¾€ä¸‹åŠ 
        =============================== */

        return (
          <div className="p-10 max-w-3xl mx-auto bg-white rounded-xl shadow">
            <h1 className="text-2xl font-bold mb-4">
              iCare ç®¡å®¶å©† Â· äº‘ç«¯å·²å¯ç”¨
            </h1>

            <pre className="text-xs bg-gray-100 p-4 rounded">
{JSON.stringify(state, null, 2)}
            </pre>

            <button
              className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded"
              onClick={() => {
                setState((s) => ({
                  ...s,
                  quotes: [
                    {
                      id: Date.now(),
                      name: "TEST QUOTE",
                      total: Math.random() * 1000
                    },
                    ...(s.quotes || [])
                  ]
                }));
              }}
            >
              â• æµ‹è¯•å†™å…¥ä¸€æ¡æŠ¥ä»·
            </button>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
